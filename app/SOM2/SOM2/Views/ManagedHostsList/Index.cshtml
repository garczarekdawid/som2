@model List<SOM2.Application.DTO.ManagedHostDto>
@using SOM2.Domain.Enums;
@using SOM2.Web.Models;
@{
    ViewData["Title"] = "Hosty Zarządzane";
}

<h1>Hosty Zarządzane</h1>

@if (TempData["Message"] != null)
{
    <div class="alert alert-info">@TempData["Message"]</div>
}

<!-- Przyciski globalne (poza tabelą) -->
<div class="mb-3">
    <form asp-action="TurnOnAll" method="post" class="d-inline">
        @Html.AntiForgeryToken()
        <button type="submit" class="btn btn-success btn-sm">Włącz wszystkie</button>
    </form>

    <form asp-action="TurnOffAll" method="post" class="d-inline">
        @Html.AntiForgeryToken()
        <button type="submit" class="btn btn-danger btn-sm">Wyłącz wszystkie</button>
    </form>
</div>

<!-- =================== -->
<!-- FORMULARZ BATCH -->
<!-- =================== -->
<form asp-action="BatchAction" method="post" id="batchForm">
    @Html.AntiForgeryToken()

    <div class="mb-2 d-flex align-items-center gap-2">
        <select class="form-select" name="Action" style="width:auto;">
            <option value="">Wybierz akcję...</option>
            <option value="@HostActionStrings.TurnOn">Włącz</option>
            <option value="@HostActionStrings.TurnOff">Wyłącz</option>
            <option value="@HostActionStrings.Restart">Restart</option>
        </select>

        <button type="submit" class="btn btn-primary btn-sm">
            Zastosuj dla zaznaczonych
        </button>
    </div>

    <table class="table table-striped table-hover align-middle">
        <thead>
            <tr>
                <th><input type="checkbox" id="checkAll" /></th>
                <th>Nazwa</th>
                <th>Opis</th>
                <th>Adres IP</th>
                <th>Adres MAC</th>
                <th>Akcje</th>
                <th>Ostatnia akcja</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var host in Model)
            {
                bool isBusy =
                host.LastActionStatus == HostActionStatus.Pending ||
                host.LastActionStatus == HostActionStatus.Running;

                <tr class="@(isBusy ? "table-secondary" : "")">
                    <td>
                        <!-- Checkbox tylko dla batchForm -->
                        <input type="checkbox"
                               name="SelectedIds"
                               value="@host.Id"
                               disabled="@isBusy"
                               form="batchForm" />
                    </td>

                    <td>@host.Name</td>
                    <td>@host.Description</td>
                    <td>@host.IpAddress</td>
                    <td>@host.MacAddress</td>

                    <td>
                        <!-- PRZYCISKI HOSTA - OSOBNE FORMUARZE (poza tabelą) -->
                        <!-- Przenosimy je do JavaScript lub użyjemy POST przez fetch -->

                        <button type="button"
                                class="btn btn-sm btn-success single-action-btn"
                                data-action="TurnOn"
                                data-host-id="@host.Id"
                                disabled="@isBusy">
                            Włącz
                        </button>

                        <button type="button"
                                class="btn btn-sm btn-warning single-action-btn"
                                data-action="Restart"
                                data-host-id="@host.Id"
                                disabled="@isBusy">
                            Restart
                        </button>

                        <button type="button"
                                class="btn btn-sm btn-danger single-action-btn"
                                data-action="TurnOff"
                                data-host-id="@host.Id"
                                disabled="@isBusy">
                            Wyłącz
                        </button>

                        @if (isBusy)
                        {
                            <span class="text-muted small ms-2">(akcja w toku)</span>
                        }
                    </td>

                    <td>
                        <strong>@host.LastActionType</strong>

                        @switch (host.LastActionStatus)
                        {
                            case HostActionStatus.Pending:
                                <span class="badge bg-secondary ms-1">Pending</span>
                                break;
                            case HostActionStatus.Running:
                                <span class="badge bg-info ms-1">Running</span>
                                break;
                            case HostActionStatus.Success:
                                <span class="badge bg-success ms-1">Success</span>
                                break;
                            case HostActionStatus.Failed:
                                <span class="badge bg-danger ms-1">Failed</span>
                                break;
                            case HostActionStatus.Cancelled:
                                <span class="badge bg-warning ms-1">Cancelled</span>
                                break;
                            default:
                                <span class="badge bg-light text-dark ms-1">–</span>
                                break;
                        }

                        @if (host.LastActionId.HasValue)
                        {
                            <a asp-controller="HostActions"
                               asp-action="Details"
                               asp-route-id="@host.LastActionId.Value"
                               class="btn btn-sm btn-outline-primary ms-2">
                                Szczegóły
                            </a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</form>

@section Scripts {
    <script>
        // Zaznacz / odznacz wszystkie checkboxy w batchForm
        document.getElementById('checkAll')?.addEventListener('click', function() {
            document.querySelectorAll('#batchForm input[name="SelectedIds"]:not(:disabled)')
                .forEach(cb => cb.checked = this.checked);
        });

        // Walidacja tylko dla batchForm
        document.getElementById('batchForm')?.addEventListener('submit', function(e) {
            const action = this.querySelector('select[name="Action"]').value;
            const checked = this.querySelectorAll('input[name="SelectedIds"]:checked').length;

            if (!action || checked === 0) {
                e.preventDefault();
                alert('Wybierz akcję i co najmniej jednego hosta');
            }
        });

        // Obsługa przycisków pojedynczych akcji (AJAX)
        document.querySelectorAll('.single-action-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const hostId = this.dataset.hostId;
                const action = this.dataset.action;
                const button = this;

                // Disable button during request
                button.disabled = true;
                const originalText = button.textContent;
                button.textContent = 'Wysyłanie...';

                try {
                    // Pobierz token anty-CSRF
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                    // Zbuduj URL zgodnie z konwencją ASP.NET Core
                    const url = `@Url.Action("TurnOn", "ManagedHostsList")`.replace('TurnOn', action);

                    // Przygotuj dane do wysłania
                    const formData = new FormData();
                    formData.append('id', hostId);

                    // Albo użyj URLSearchParams dla application/x-www-form-urlencoded
                    const params = new URLSearchParams();
                    params.append('id', hostId);
                    params.append('__RequestVerificationToken', token);

                    // Wyślij żądanie POST
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': token
                        },
                        body: params
                    });

                    if (response.ok) {
                        // Sprawdź, czy odpowiedź to przekierowanie
                        if (response.redirected) {
                            // Jeśli tak, przeładuj stronę
                            window.location.href = response.url;
                        } else {
                            // W przeciwnym razie przeładuj stronę
                            window.location.reload();
                        }
                    } else {
                        // Spróbuj wyciągnąć więcej informacji o błędzie
                        const errorText = await response.text();
                        console.error('Błąd odpowiedzi:', response.status, errorText);
                        alert(`Wystąpił błąd (${response.status}): ${response.statusText}`);
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                } catch (error) {
                    console.error('Błąd połączenia:', error);
                    alert('Błąd połączenia: ' + error.message);
                    button.disabled = false;
                    button.textContent = originalText;
                }
            });
        });
    </script>
}