@model List<SOM2.Application.DTO.ManagedHostDto>
@using SOM2.Domain.Enums;

@{
    ViewData["Title"] = "Hosty Zarządzane";
}

<h1>Hosty Zarządzane</h1>

@if (TempData["Message"] != null)
{
    <div class="alert alert-info">@TempData["Message"]</div>
}

<!-- Przyciski globalne -->
<div class="mb-3">
    <form asp-action="TurnOnAll" method="post" class="d-inline">
        <button type="submit" class="btn btn-success btn-sm">Włącz wszystkie</button>
    </form>
    <form asp-action="TurnOffAll" method="post" class="d-inline">
        <button type="submit" class="btn btn-danger btn-sm">Wyłącz wszystkie</button>
    </form>
</div>

<!-- Formularz dla zaznaczonych hostów -->
<form asp-action="BatchAction" method="post" id="batchForm">
    @Html.AntiForgeryToken()

    <div class="mb-2 d-flex align-items-center gap-2">
        <select class="form-select" name="Action" style="width:auto;">
            <option value="">Wybierz akcję...</option>
            <option value="TurnOn">Włącz</option>
            <option value="TurnOff">Wyłącz</option>
            <option value="Restart">Restart</option>
        </select>
        <button type="submit" class="btn btn-primary btn-sm">Zastosuj dla zaznaczonych</button>
    </div>

    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th><input type="checkbox" id="checkAll" /></th>
                <th>Nazwa</th>
                <th>Opis</th>
                <th>Adres IP</th>
                <th>Adres MAC</th>
                <th>Akcje</th>
                <th>Ostatnia akcja</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var host in Model)
            {
                <tr>
                    <td><input type="checkbox" name="SelectedIds" value="@host.Id" /></td>
                    <td>@host.Name</td>
                    <td>@host.Description</td>
                    <td>@host.IpAddress</td>
                    <td>@host.MacAddress</td>
                    <td>
                        <!-- używamy przycisków z formaction zamiast zagnieżdżonych formularzy -->
                        <button type="submit"
                                class="btn btn-sm btn-success"
                                formaction="@Url.Action("TurnOn", "ManagedHostsList")"
                                formmethod="post"
                                name="id"
                                value="@host.Id">
                            Włącz
                        </button>

                        <button type="submit"
                                class="btn btn-sm btn-warning"
                                formaction="@Url.Action("Restart", "ManagedHostsList")"
                                formmethod="post"
                                name="id"
                                value="@host.Id">
                            Restart
                        </button>

                        <button type="submit"
                                class="btn btn-sm btn-danger"
                                formaction="@Url.Action("TurnOff", "ManagedHostsList")"
                                formmethod="post"
                                name="id"
                                value="@host.Id">
                            Wyłącz
                        </button>
                    </td>
                    <td>@host.LastActionType
                        @switch (host.LastActionStatus)
                        {
                            case HostActionStatus.Pending:
                                <span class="badge bg-secondary">Pending</span>
                                ;
                                break;
                            case HostActionStatus.Running:
                                <span class="badge bg-info">Running</span>
                                ;
                                break;
                            case HostActionStatus.Success:
                                <span class="badge bg-success">Success</span>
                                ;
                                break;
                            case HostActionStatus.Failed:
                                <span class="badge bg-danger">Failed</span>
                                ;
                                break;
                            case HostActionStatus.Cancelled:
                                <span class="badge bg-warning">Cancelled</span>
                                ;
                                break;
                            default:
                                <span class="badge bg-light text-dark">–</span>
                                ;
                                break;
                        }

                        @if (host.LastActionId.HasValue)
                        {
                            <a asp-controller="HostActions"
                               asp-action="Details"
                               asp-route-id="@host.LastActionId.Value"
                               class="btn btn-sm btn-outline-primary ms-2">
                                Szczegóły
                            </a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</form>

@section Scripts {
    <script>
        // Guard dla bezpieczeństwa — element może nie istnieć w DOM
        var checkAllEl = document.getElementById('checkAll');
        if (checkAllEl) {
            checkAllEl.addEventListener('click', function () {
                var checkboxes = document.querySelectorAll('input[name="SelectedIds"]');
                checkboxes.forEach(cb => cb.checked = this.checked);
            });
        }
    </script>

}
